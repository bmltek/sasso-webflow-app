---
parameters:
  sonarProjectKey: 'princemike05_Sasso-Webflow'
  sonarOrganization: 'princemike05'

stages:
- stage: CodeAnalysis
  displayName: 'Code Analysis and Testing'
  jobs:
  - job: Analysis
    steps:
    - checkout: self
      fetchDepth: 0
      
    - task: SonarCloudPrepare@1
      displayName: 'Prepare SonarCloud Analysis'
      inputs:
        SonarCloud: 'sonarcloud-connection'
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: '${{ parameters.sonarProjectKey }}'
        cliProjectName: '${{ parameters.sonarProjectKey }}'
        cliSources: '.'
        organization: '${{ parameters.sonarOrganization }}'
        extraProperties: |
          sonar.projectKey=${{ parameters.sonarProjectKey }}
          sonar.organization=${{ parameters.sonarOrganization }}
          sonar.sources=src
          sonar.tests=src
          sonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
          sonar.typescript.lcov.reportPaths=coverage/lcov.info
          sonar.javascript.lcov.reportPaths=coverage/lcov.info
          sonar.coverage.exclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx,**/tests/**/*
          sonar.cpd.exclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
          sonar.sourceEncoding=UTF-8
          sonar.verbose=true

    - task: Npm@1
      displayName: 'Install dependencies'
      inputs:
        command: 'install'
        workingDir: '.'

    - task: Npm@1
      displayName: 'Install testing dependencies'
      inputs:
        command: 'custom'
        workingDir: '.'
        customCommand: 'install -D ts-node @testing-library/react @testing-library/jest-dom @testing-library/user-event jest-environment-jsdom identity-obj-proxy'

    - task: Npm@1
      displayName: 'Run tests with coverage'
      inputs:
        command: 'custom'
        workingDir: '.'
        customCommand: 'test -- --coverage --coverageReporters=text --coverageReporters=lcov'

    - task: SonarCloudAnalyze@1
      displayName: 'Run SonarCloud Analysis'

    - task: SonarCloudPublish@1
      displayName: 'Publish Quality Gate Result'
      inputs:
        pollingTimeoutSec: '300'

    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Code Coverage'
      inputs:
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/lcov.info'
        pathToSources: '$(System.DefaultWorkingDirectory)/src'
        failIfCoverageEmpty: true
        codecoverageTool: 'Cobertura'

    - task: Docker@2
      displayName: 'Build and scan frontend Docker image'
      inputs:
        command: 'build'
        Dockerfile: 'frontend/Dockerfile'
        repository: 'frontend'
        tags: |
          latest
          $(Build.BuildId)
        arguments: '--no-cache --security-opt=no-new-privileges:true --security-opt=no-new-privileges:true'

    - task: Docker@2
      displayName: 'Scan Docker image for vulnerabilities'
      inputs:
        command: 'scan'
        image: 'frontend:latest'
        severity: 'HIGH,CRITICAL'
        failOnSeverity: 'HIGH'
        outputFile: 'docker-scan-results.json'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Docker scan results'
      inputs:
        targetPath: 'docker-scan-results.json'
        artifact: 'docker-scan-results'
        publishLocation: 'pipeline' 