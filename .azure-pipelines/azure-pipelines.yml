trigger:
  branches:
    include:
    - main
  paths:
    include:
    - services/*
    - frontend/*
    - helm/*

variables:
  - group: azure-config
  - name: vmImageName
    value: 'ubuntu-latest'

stages:
- stage: Build
  jobs:
  - job: BuildServices
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Login to ACR
      inputs:
        command: login
        containerRegistry: $(ACR_SERVICE_CONNECTION)

    # Build and push services
    - ${{ each service in parameters.services }}:
      - template: templates/build-service.yml
        parameters:
          serviceName: ${{ service }}
          serviceDirectory: services/${{ service }}

- stage: Deploy
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployToAKS
    environment: 'production'
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - template: templates/deploy-services.yml